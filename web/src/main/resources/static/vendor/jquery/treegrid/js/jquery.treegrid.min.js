!function(e){e.fn.treegrid=function(n){return t[n]?t[n].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof n&&n?void e.error("Method with name "+n+" does not exists for jQuery.treegrid"):function(n){var r=e(this),a=e.extend({},e.fn.treegrid.defaults,n);return r.each(function(){var n=e(this);n.data("treegrid-settings",a),n.on("click",">tbody>tr>td:first-child>.treegrid-container>.treegrid-expander",u).on("mousedown",">tbody>tr>td:first-child>.treegrid-container",A).on("dblclick",">tbody>tr>td:first-child>.treegrid-container>.treegrid-expander",f),c(t.getRoots.call(n),1)})}.apply(this,arguments)},e.fn.treegrid.defaults={source:null,enableMove:!1,moveDistance:10,moveHandle:!1,onExpand:function(){return!0},onCollapse:function(){return!0},onAdd:function(){},onMoveStart:function(){},onMoveStop:function(){},onMoveOver:function(){return!0},onMoveOut:function(){},onMove:function(){return!0}};var t={option:function(t,n){var r=this.data("treegrid-settings");return"string"===e.type(t)&&void 0!==n&&(t={optionName:n}),e.isPlainObject(t)?(r=e.extend({},r,t),this.data("treegrid-settings",r)):"string"===e.type(t)?r[t]:r},getId:function(){return d(this)},getDepth:function(){return this.data("treegrid-depth")},toggle:function(){return this.each(function(){$this=e(this),l($this)?t.collapse.call($this):s($this)&&t.expand.call($this)})},expand:function(){return this.each(function(){var r=e(this);s(r)&&(r.data("loaded")||function(r){var a=r.closest("table").data("treegrid-settings");i(r).not(r).remove(),e.isFunction(a.source)&&!r.hasClass("loading")&&(r.addClass("loading"),a.source.call(r,d(r),function(e){r.removeData("loadNeeded").data("loaded",!0),n(r,e),r.removeClass("loading"),t.expand.call(r)}));"string"!==e.type(a.source)||r.hasClass("loading")||(r.addClass("loading"),e.post(a.source,{id:d(r)},function(e){r.removeDate("loadNeeded").data("loaded",!0),n(r,e),r.removeClass("loading")},"json"));return!1}(r))&&(!function(t){if(!t.closest("table").data("treegrid-settings").onExpand.call(t))return;t.addClass("expanded"),t.find(">td:first>.treegrid-container>.treegrid-expander").removeClass("treegrid-expander-collapsed").addClass("treegrid-expander-expanded"),i(t).not(t).each(function(){var t=e(this);p(t)?t.hide():t.show()})}(r),!0)}),w&&j(),this},collapse:function(){return this.each(function(){var t=e(this);l(t)&&(!function(e){if(!e.closest("table").data("treegrid-settings").onCollapse.call(e))return;e.removeClass("expanded"),e.find(">td:first>.treegrid-container>.treegrid-expander").removeClass("treegrid-expander-expanded").addClass("treegrid-expander-collapsed"),i(e).not(e).hide()}(t),!0)}),w&&j(),this},add:function(t){return this.each(function(){n(e(this),t)}),w&&j(),this},remove:function(){return this.each(function(){var t=e(this),n=r(t);i(t).remove(),c(n,n.data("treegrid-depth"))}),w&&j(),this},move:function(e,t){var n,a,s,l=r(this);if(s=i(this),n=0==t?e.prev():i(e).not(s).last(),-1==s.index(n)){a=1===t?d(e):o(e),this.removeClass("treegrid-parent-"+o(this)),null!==a&&this.addClass("treegrid-parent-"+a),n.length?s.insertAfter(n):s.prependTo(this.parent()),p(this)&&s.hide(),l.length&&c(l,l.data("treegrid-depth"));var u=r(this);u.length?c(u,u.data("treegrid-depth")):c(this)}},getRoots:function(){var t=[];return this.find(">tbody>tr").each(function(){null===o(e(this))&&t.push(this)}),e(t)},getChildNodes:function(){var t=e();return this.each(function(){t=t.add(a(e(this)))}),t},getBranch:function(){var t=e();return this.each(function(){t=t.add(i(e(this)))}),t},getParent:function(){var t=e();return this.each(function(){t=t.add(r(e(this)))}),t},isCollapsed:function(){var t=!1;return this.each(function(){if(t=s(e(this)))return!1}),t},isExpanded:function(){var t=!1;return this.each(function(){if(t=l(e(this)))return!1}),t},isLeaf:function(){return 0===e(this).treegrid("getChildNodes").length},expandRecursive:function(){return e(this).each(function(){var t=e(this);t.treegrid("expand"),t.treegrid("isLeaf")||t.treegrid("getChildNodes").treegrid("expandRecursive")})}};function n(t,n){var r,a=i(t).last().next(),o=[],s=d(t),l=t;"TABLE"!==l.prop("tagName")&&(l=l.closest("table")),r=l.find(">thead>tr,>tbody>tr").first().find(">th,>td").length,e.each(n,function(t,n){var i=e(n);if(!l.find(">tbody>tr.treegrid-"+d(i)).length){null!==s&&i.addClass("treegrid-parent-"+s);var c=i.find(">td").length;if(c<r)for(t=i.find(">td").length;t<r;t++)i.append("<td>");else c>r&&i.find(">td").eq(r-1).nextAll().remove();a.length?i.insertBefore(a):l.find(">tbody").append(i),o.push(i[0])}}),o=e(o),null===s&&c(o),c(t,t.data("treegrid-depth")),t.closest("table").data("treegrid-settings").onAdd.call(t,o)}function r(e){return e.parent().find(">.treegrid-"+o(e))}function a(e){return e.parent().find(">.treegrid-parent-"+d(e))}function i(t){var n=t;return"TR"!==t.prop("tagName")?n.not(t):(a(t).each(function(){n=n.add(i(e(this)))}),n)}function d(e){var t=/treegrid-([A-Fa-f0-9_]+)/;return t.test(e.attr("class"))?t.exec(e.attr("class"))[1]:null}function o(e){var t=/treegrid-parent-([A-Fa-f0-9_]+)/;return t.test(e.attr("class"))?t.exec(e.attr("class"))[1]:null}function s(e){return e.data("count")&&!e.hasClass("expanded")}function l(e){return e.data("count")&&e.hasClass("expanded")}function c(t,n,r){void 0===n&&(n=1),t.each(function(){var t=e(this).data("treegrid-depth",n),i=a(t),d=i.length;void 0===t.data("count")||t.data("loaded")||t.data("count")==d?t.data("loadNeeded")||(t.data({loaded:!0,count:d}),d&&r&&t.addClass("expanded")):t.data("loadNeeded",!0),$td=t.find(">td:first"),$container=$td.find(">.treegrid-container"),0===$container.length&&($container=e('<div class="treegrid-container">').html($td.html()),$td.html("").append($container)),$container.find(".treegrid-expander").remove(),$expander=e('<span class="treegrid-expander">').prependTo($container),t.data("count")&&(t.hasClass("expanded")?$expander.addClass("treegrid-expander-expanded"):$expander.addClass("treegrid-expander-collapsed")),$container.css("marginLeft",n*$expander.width()),p(t)&&t.hide(),c(i,n+1,r)})}function u(){var n=e(this);(n.hasClass("treegrid-expander-expanded")||n.hasClass("treegrid-expander-collapsed"))&&t.toggle.call(n.closest("tr"))}function f(){var n=e(this);(n.hasClass("treegrid-expander-expanded")||n.hasClass("treegrid-expander-collapsed"))&&t.expandRecursive.call(n.closest("tr"))}function p(e){if(null===o(e))return!1;var t=r(e);return!!s(t)||p(t)}var h,g,v,x,m,C,b,y=null,$=null,M=null,w=!1,N=!1,T=!1;function A(t){if(0===t.button){var n=e(this),r=n.closest("table").data("treegrid-settings");if(r.enableMove){var a=e(t.target);if(!a.hasClass("treegrid-expander")&&(!1===r.moveHandle||n.find(r.moveHandle)[0]==a[0])){y=n.closest("tr"),g=t.pageX,v=t.pageY;var i=n.offset();return x=i.left-t.pageX,m=i.top-t.pageY,e(document).on("mouseup",R).on("mousemove",X),!1}}}}function R(n){w&&function(){w=!1,!1!==T&&(window.clearTimeout(T),T=!1);$.remove(),h.remove();var e=y.closest("table");e.data("treegrid-settings").onMoveStop.call(e,y),N&&function(){Y();var e=y.closest("table");!1!==e.data("treegrid-settings").onMove.call(e,y,M,b)&&t.move.call(y,M,b)}()}(),e(document).off("mouseup",R).off("mousemove",X)}function X(n){Math.max(Math.abs(n.pageX-g),Math.abs(n.pageY-v))>=y.closest("table").data("treegrid-settings").moveDistance&&!w?function(t){if(w=!0,j(),($=y.find(">td:first>.treegrid-container").clone().addClass("dragging").css({left:t.pageX+x,top:t.pageY+m})).find(">.treegrid-expander").remove(),$.appendTo("body"),e(".treegrid-move-indicator").length)return;h=e('<div class="treegrid-move-indicator">').appendTo("body");var n=y.closest("table");n.data("treegrid-settings").onMoveStart.call(n,y,$)}(n):w&&function(n){$.css({left:n.pageX+x,top:n.pageY+m});var r=function(t,n){var r=null,a={node:null,position:null,top:null};if(e.each(C,function(e,i){if(t>=i[0]&&n>=i[1]&&t<=i[0]+i[2]&&n<=i[1]+i[3])return r=i,a.node=i[4],!1}),null!==r){var i=r[3]/4,d=3*i,o=n-r[1];o<i?(a.position=0,a.top=r[1]):o>=d?(a.position=2,a.top=r[1]+r[3]):(a.position=1,a.top=r[1]+r[3]/2)}return a}(n.pageX,n.pageY);if(M===r.node&&b===r.position)return;null!==M&&Y();M=r.node,b=r.position,null!==M&&function(e){if(1==e.position){var n=e.node;!1===T&&s(n)&&(T=window.setTimeout(function(){t.expand.call(n),T=!1},500))}else!1!==T&&(window.clearTimeout(T),T=!1);N=!0;var r=y.closest("table");!1===r.data("treegrid-settings").onMoveOver.call(r,y,$,e.node,e.position)&&(N=!1);N&&h.css({display:"block",left:e.node.find(">td:first>.treegrid-container").offset().left,top:e.top})}(r)}(n)}function Y(){!1!==T&&(window.clearTimeout(T),T=!1),N=!1,h.hide();var e=y.closest("table");e.data("treegrid-settings").onMoveOut.call(e,y,$,M)}function j(){var t=[];i(y).each(function(){t.push(d(e(this)))}),C=[],y.parent().find("tr").each(function(){var n=e(this),r=d(n);if(null!==r&&-1===e.inArray(r,t)){var a=n.offset();C.push([a.left,a.top,n.width(),n.height(),n])}})}}(jQuery);